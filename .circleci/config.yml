# Use the latest 2.1 version of CircleCI pipeline process engine. 
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# orbs:
#   # The Node.js orb contains a set of prepackaged CircleCI configuration you can utilize
#   # Orbs reduce the amount of configuration required for common tasks. 
#   # See the orb documentation here: https://circleci.com/developer/orbs/orb/circleci/node
#   # node: circleci/node@4.1
#   cypress: cypress-io/cypress@1


jobs:
  # Below is the definition of your job to build and test your app, you can rename and customize it as you want.
  build:
    working_directory: ~/tmp
    docker:
      - image: cypress/base:14.16.0
    steps:
      - checkout
      - run:
          name: Install packages 
          command: npm install
      - restore_cache:
          keys:
            - 'v2-deps-{{ .Branch }}-{{ checksum "package-lock.json" }}'
            - 'v2-deps-{{ .Branch }}-'
            - v2-deps-
      - save_cache:
          key: 'v2-deps-{{ .Branch }}-{{ checksum "package-lock.json" }}'
          paths:
            - ~/.npm
            - ~/.cache
      - persist_to_workspace:
          root: ~/
          paths:
            - .cache
            - tmp
  test-course:  
    working_directory: ~/tmp
    docker:
      - image: cypress/base:14.16.0
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Run tests Course project
          command: npm run test:course
      - store_artifacts:
          path: allure-results
  test-graduation:  
    working_directory: ~/tmp
    docker:
      - image: cypress/base:14.16.0
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Run tests Graduation project
          command: npm run test:graduation
      - store_artifacts:
          path: allure-results
workflows:
  build_and_test:
    jobs:
      - build
      - test-course:
          requires:
            - build
      - test-graduation:
          requires:
            - build
